<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>The Greenkeeper ‚Äî Golf Course Designer</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;0,900;1,400&family=Crimson+Text:ital,wght@0,400;0,600;1,400&family=IM+Fell+English+SC&display=swap" rel="stylesheet">
<style>
  :root {
    --green-deep: #1a3a1a;
    --green-mid: #2d5a27;
    --green-fairway: #4a7c3f;
    --green-light: #6aab5a;
    --tan: #c8a96e;
    --tan-light: #e8d5a3;
    --cream: #f5eed8;
    --brown: #6b4c2a;
    --brown-dark: #3d2b15;
    --ink: #1c1008;
    --red-flag: #b83232;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'Crimson Text', serif; background: var(--cream); color: var(--ink); min-height: 100vh; overflow: hidden; }
  body::before {
    content:''; position:fixed; inset:0; pointer-events:none; z-index:0;
    background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='4' height='4'%3E%3Crect width='4' height='4' fill='%23f5eed8'/%3E%3Ccircle cx='1' cy='1' r='0.5' fill='%23c8a96e22'/%3E%3Ccircle cx='3' cy='3' r='0.5' fill='%23c8a96e22'/%3E%3C/svg%3E");
  }

  /* HEADER */
  header { background:var(--green-deep); border-bottom:4px solid var(--tan); position:relative; z-index:10; }
  .header-inner { display:flex; align-items:center; justify-content:space-between; padding:10px 18px; gap:14px; }
  .logo-title { font-family:'IM Fell English SC',serif; font-size:24px; color:var(--tan); letter-spacing:2px; line-height:1; }
  .logo-sub { font-family:'Crimson Text',serif; font-style:italic; font-size:12px; color:var(--tan-light); letter-spacing:3px; opacity:.8; }
  .course-name-area { flex:1; max-width:300px; margin:0 auto; }
  #course-name { font-family:'Playfair Display',serif; font-size:18px; font-style:italic; color:var(--cream); background:transparent; border:none; border-bottom:1px solid var(--tan); text-align:center; width:100%; padding:4px 8px; outline:none; }
  #course-name::placeholder { color:rgba(245,238,216,0.4); }
  .header-actions { display:flex; gap:6px; align-items:center; }
  .btn { font-family:'IM Fell English SC',serif; font-size:11px; letter-spacing:1px; padding:6px 12px; border:1px solid var(--tan); background:transparent; color:var(--tan-light); cursor:pointer; transition:all .2s; }
  .btn:hover { background:var(--tan); color:var(--brown-dark); }
  .btn.primary { background:var(--tan); color:var(--brown-dark); }
  .btn.primary:hover { background:var(--tan-light); }

  /* BUDGET BADGE */
  .budget-badge { display:flex; flex-direction:column; align-items:flex-end; font-family:'IM Fell English SC',serif; font-size:10px; letter-spacing:1px; padding:4px 10px; border:1px solid var(--tan); border-radius:2px; min-width:170px; }
  .budget-badge .bb-label { color:var(--tan); font-size:9px; opacity:.8; margin-bottom:2px; }
  .budget-badge .bb-bar-wrap { width:100%; background:rgba(255,255,255,0.1); height:5px; border-radius:2px; margin:2px 0; }
  .budget-badge .bb-bar { height:5px; border-radius:2px; transition:width .3s,background .3s; }
  .budget-badge .bb-nums { display:flex; justify-content:space-between; width:100%; font-size:10px; color:var(--tan-light); }

  /* LAYOUT */
  .app-layout { display:grid; grid-template-columns:270px 1fr 270px; height:calc(100vh - 64px); position:relative; z-index:1; }

  /* PANELS */
  .panel { background:var(--green-deep); border-right:3px solid var(--tan); display:flex; flex-direction:column; overflow:hidden; }
  .panel.right { border-right:none; border-left:3px solid var(--tan); }
  .panel-header { background:var(--brown-dark); padding:9px 14px; border-bottom:2px solid var(--tan); font-family:'IM Fell English SC',serif; font-size:13px; letter-spacing:2px; color:var(--tan); text-align:center; }
  .tool-section { padding:9px 11px; border-bottom:1px solid rgba(200,169,110,0.2); }
  .tool-section-label { font-family:'IM Fell English SC',serif; font-size:9px; letter-spacing:2px; color:var(--tan); opacity:.7; margin-bottom:5px; }
  .tool-grid { display:grid; grid-template-columns:1fr 1fr; gap:4px; }
  .tool-btn { font-family:'Crimson Text',serif; font-size:11px; padding:6px 4px; background:rgba(200,169,110,0.1); border:1px solid rgba(200,169,110,0.3); color:var(--tan-light); cursor:pointer; transition:all .2s; text-align:center; border-radius:2px; display:flex; flex-direction:column; align-items:center; gap:1px; }
  .tool-btn:hover,.tool-btn.active { background:rgba(200,169,110,0.3); border-color:var(--tan); color:var(--cream); }
  .tool-icon { font-size:16px; }
  .tool-cost { font-size:8px; color:var(--tan); opacity:.7; font-family:'IM Fell English SC',serif; letter-spacing:.5px; }

  /* HOLE LIST */
  .hole-list { flex:1; overflow-y:auto; padding:5px; }
  .hole-list::-webkit-scrollbar { width:4px; }
  .hole-list::-webkit-scrollbar-thumb { background:var(--tan); border-radius:2px; }
  .hole-item { background:rgba(200,169,110,0.08); border:1px solid rgba(200,169,110,0.2); border-radius:2px; padding:6px 8px; margin-bottom:4px; cursor:pointer; transition:all .15s; position:relative; }
  .hole-item:hover,.hole-item.selected { background:rgba(200,169,110,0.2); border-color:var(--tan); }
  .hole-item-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:2px; }
  .hole-number { font-family:'IM Fell English SC',serif; font-size:11px; color:var(--tan); letter-spacing:1px; }
  .hole-par { font-size:10px; color:var(--green-light); }
  .hole-name-input,.hole-detail-input { background:transparent; border:none; border-bottom:1px solid rgba(200,169,110,0.3); color:var(--cream); font-family:'Crimson Text',serif; font-size:11px; width:100%; outline:none; padding:1px 0; margin-bottom:2px; }
  .hole-name-input:focus,.hole-detail-input:focus { border-bottom-color:var(--tan); }
  .hole-details-row { display:grid; grid-template-columns:1fr 1fr 1fr; gap:3px; }
  .detail-label { font-size:8px; color:rgba(200,169,110,0.6); font-family:'IM Fell English SC',serif; letter-spacing:1px; }
  .hole-delete { position:absolute; top:4px; right:4px; background:none; border:none; color:rgba(184,50,50,0.5); cursor:pointer; font-size:12px; padding:0 2px; line-height:1; transition:color .2s; }
  .hole-delete:hover { color:var(--red-flag); }
  .inline-select { background:transparent; border:none; border-bottom:1px solid rgba(200,169,110,0.3); color:var(--cream); font-family:'Crimson Text',serif; font-size:11px; outline:none; width:100%; cursor:pointer; padding:1px 0; }
  .inline-select option { background:var(--green-deep); color:var(--cream); }

  /* CANVAS */
  .canvas-area { position:relative; overflow:hidden; background:#2a5a22; cursor:crosshair; }
  #main-canvas { display:block; width:100%; height:100%; }
  .canvas-instructions { position:absolute; bottom:12px; left:50%; transform:translateX(-50%); background:rgba(26,58,26,0.9); border:1px solid var(--tan); color:var(--tan-light); font-family:'Crimson Text',serif; font-style:italic; font-size:12px; padding:5px 14px; pointer-events:none; white-space:nowrap; }
  .canvas-zoom { position:absolute; top:10px; right:10px; display:flex; gap:4px; }
  .canvas-zoom button { width:26px; height:26px; background:rgba(26,58,26,0.85); border:1px solid var(--tan); color:var(--tan); font-size:15px; cursor:pointer; display:flex; align-items:center; justify-content:center; transition:background .15s; }
  .canvas-zoom button:hover { background:rgba(200,169,110,0.3); }

  /* MEASURE TOOLTIP */
  #measure-tooltip { position:fixed; pointer-events:none; display:none; background:rgba(20,16,6,0.92); border:1px solid var(--tan); color:var(--tan-light); font-family:'IM Fell English SC',serif; font-size:13px; letter-spacing:1px; padding:5px 13px; border-radius:2px; white-space:nowrap; z-index:200; }

  /* RIGHT PANEL */
  .scorecard-wrap { flex:1; overflow-y:auto; padding:9px; }
  .scorecard-wrap::-webkit-scrollbar { width:4px; }
  .scorecard-wrap::-webkit-scrollbar-thumb { background:var(--tan); }
  .scorecard-title { font-family:'IM Fell English SC',serif; font-size:11px; color:var(--tan); text-align:center; letter-spacing:2px; margin-bottom:6px; padding-bottom:4px; border-bottom:1px solid rgba(200,169,110,0.3); }
  table.scorecard { width:100%; border-collapse:collapse; font-size:10px; }
  table.scorecard th { font-family:'IM Fell English SC',serif; font-size:9px; letter-spacing:1px; color:var(--tan); padding:3px 2px; text-align:center; border-bottom:1px solid rgba(200,169,110,0.4); }
  table.scorecard td { padding:3px 2px; text-align:center; color:var(--cream); font-family:'Crimson Text',serif; border-bottom:1px solid rgba(200,169,110,0.1); font-size:10px; }
  table.scorecard tr:hover td { background:rgba(200,169,110,0.1); }
  .sc-total { font-family:'IM Fell English SC',serif; color:var(--tan) !important; font-size:11px !important; }
  .par3 { color:#6aab5a !important; }
  .par4 { color:var(--tan-light) !important; }
  .par5 { color:#e8a060 !important; }
  .stat-box { background:rgba(200,169,110,0.08); border:1px solid rgba(200,169,110,0.2); border-radius:2px; padding:5px 8px; margin-top:5px; display:flex; justify-content:space-between; align-items:center; }
  .stat-label { font-family:'IM Fell English SC',serif; font-size:9px; letter-spacing:1px; color:var(--tan); opacity:.8; }
  .stat-value { font-family:'Playfair Display',serif; font-size:14px; color:var(--cream); }

  /* BUDGET PANEL */
  .budget-panel { padding:10px 12px; border-top:2px solid var(--tan); background:rgba(0,0,0,0.25); flex-shrink:0; }
  .budget-panel-title { font-family:'IM Fell English SC',serif; font-size:12px; letter-spacing:2px; color:var(--tan); margin-bottom:7px; text-align:center; }
  .budget-input-row { display:flex; align-items:center; gap:6px; margin-bottom:7px; }
  .budget-input-row label { font-family:'IM Fell English SC',serif; font-size:9px; color:var(--tan); letter-spacing:1px; white-space:nowrap; }
  #budget-input { font-family:'Crimson Text',serif; font-size:14px; background:transparent; border:none; border-bottom:1px solid var(--tan); color:var(--cream); outline:none; width:100%; padding:2px 4px; text-align:right; }
  .budget-bar-wrap { width:100%; background:rgba(255,255,255,0.1); height:7px; border-radius:4px; margin:5px 0; overflow:hidden; }
  .budget-bar-fill { height:100%; border-radius:4px; transition:width .4s,background .4s; }
  .budget-breakdown { font-size:10px; }
  .budget-line { display:flex; justify-content:space-between; align-items:center; padding:2px 0; border-bottom:1px solid rgba(200,169,110,0.1); color:var(--tan-light); font-family:'Crimson Text',serif; }
  .budget-line .bl-name { display:flex; align-items:center; gap:4px; font-size:11px; }
  .budget-line .bl-dot { width:9px; height:9px; border-radius:50%; flex-shrink:0; }
  .budget-line .bl-cost { font-family:'IM Fell English SC',serif; font-size:10px; color:var(--tan); }
  .budget-total-row { display:flex; justify-content:space-between; padding:5px 0 2px; font-family:'IM Fell English SC',serif; font-size:12px; color:var(--tan); border-top:1px solid var(--tan); margin-top:4px; }
  .clr-ok { color:#6aab5a; }
  .clr-warn { color:#e8a060; }
  .clr-over { color:var(--red-flag); }

  /* CONTEXT MENU */
  #context-menu { position:fixed; background:var(--brown-dark); border:1px solid var(--tan); z-index:1000; display:none; flex-direction:column; min-width:130px; }
  #context-menu button { font-family:'Crimson Text',serif; font-size:13px; padding:7px 12px; background:none; border:none; color:var(--cream); cursor:pointer; text-align:left; transition:background .15s; }
  #context-menu button:hover { background:rgba(200,169,110,0.2); }
  #context-menu button.sep { border-top:1px solid rgba(200,169,110,0.2); }

  /* MODAL */
  .modal-backdrop { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:500; align-items:center; justify-content:center; }
  .modal-backdrop.open { display:flex; }
  .modal { background:var(--cream); border:3px solid var(--tan); padding:22px 26px; min-width:290px; }
  .modal-title { font-family:'Playfair Display',serif; font-size:19px; font-style:italic; color:var(--brown-dark); margin-bottom:14px; border-bottom:1px solid var(--tan); padding-bottom:7px; }
  .form-row { margin-bottom:11px; display:flex; flex-direction:column; gap:3px; }
  .form-row label { font-family:'IM Fell English SC',serif; font-size:9px; letter-spacing:2px; color:var(--brown); }
  .form-row input,.form-row select { font-family:'Crimson Text',serif; font-size:14px; padding:5px 7px; border:1px solid var(--tan); background:var(--cream); color:var(--ink); outline:none; }
  .form-row-inline { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
  .modal-actions { display:flex; gap:8px; justify-content:flex-end; margin-top:14px; }
  .btn-modal { font-family:'IM Fell English SC',serif; letter-spacing:1px; padding:7px 15px; border:1px solid var(--brown); background:transparent; color:var(--brown-dark); cursor:pointer; font-size:11px; transition:all .2s; }
  .btn-modal.save { background:var(--green-deep); color:var(--tan-light); border-color:var(--green-deep); }
  .btn-modal:hover { opacity:.8; }
  .empty-hint { text-align:center; padding:14px 8px; font-style:italic; color:rgba(200,169,110,0.5); font-size:11px; line-height:1.6; }
</style>
</head>
<body>

<header>
  <div class="header-inner">
    <div class="logo">
      <div class="logo-title">The Greenkeeper</div>
      <div class="logo-sub">Golf Course Designer</div>
    </div>
    <div class="course-name-area">
      <input type="text" id="course-name" placeholder="Enter Course Name‚Ä¶" maxlength="50">
    </div>
    <div class="budget-badge" id="header-budget-badge">
      <span class="bb-label">Build Budget</span>
      <div class="bb-bar-wrap"><div class="bb-bar" id="hb-bar" style="width:0%;background:#27ae60;"></div></div>
      <div class="bb-nums"><span id="hb-spent">$0</span><span id="hb-total">/ $5,000,000</span></div>
    </div>
    <div class="header-actions">
      <button class="btn" onclick="clearCanvas()">Clear</button>
      <button class="btn primary" onclick="saveCourse()">üíæ Save</button>
      <button class="btn" onclick="loadCourse()">üìÇ Load</button>
    </div>
  </div>
</header>

<div class="app-layout">

  <!-- LEFT PANEL -->
  <div class="panel">
    <div class="panel-header">üñä Design Tools</div>

    <div class="tool-section">
      <div class="tool-section-label">Terrain (cost per paint unit)</div>
      <div class="tool-grid">
        <button class="tool-btn active" id="tool-fairway" onclick="setTool('fairway')">
          <span class="tool-icon">üåø</span>Fairway<span class="tool-cost">$800/unit</span>
        </button>
        <button class="tool-btn" id="tool-rough" onclick="setTool('rough')">
          <span class="tool-icon">üåæ</span>Rough<span class="tool-cost">$200/unit</span>
        </button>
        <button class="tool-btn" id="tool-green" onclick="setTool('green')">
          <span class="tool-icon">üü¢</span>Green<span class="tool-cost">$3,500/unit</span>
        </button>
        <button class="tool-btn" id="tool-bunker" onclick="setTool('bunker')">
          <span class="tool-icon">üèñ</span>Bunker<span class="tool-cost">$1,200/unit</span>
        </button>
        <button class="tool-btn" id="tool-water" onclick="setTool('water')">
          <span class="tool-icon">üíß</span>Water<span class="tool-cost">$2,000/unit</span>
        </button>
        <button class="tool-btn" id="tool-trees" onclick="setTool('trees')">
          <span class="tool-icon">üå≤</span>Trees<span class="tool-cost">$400/unit</span>
        </button>
        <button class="tool-btn" id="tool-path" onclick="setTool('path')">
          <span class="tool-icon">üõ§</span>Cart Path<span class="tool-cost">$600/unit</span>
        </button>
        <button class="tool-btn" id="tool-erase" onclick="setTool('erase')">
          <span class="tool-icon">üóë</span>Erase<span class="tool-cost">free</span>
        </button>
      </div>
    </div>

    <div class="tool-section">
      <div class="tool-section-label">Place Objects</div>
      <div class="tool-grid">
        <button class="tool-btn" id="tool-tee" onclick="setTool('tee')">
          <span class="tool-icon">üèå</span>Tee Box<span class="tool-cost">$5,000 ea</span>
        </button>
        <button class="tool-btn" id="tool-flag" onclick="setTool('flag')">
          <span class="tool-icon">‚õ≥</span>Flag/Hole<span class="tool-cost">$8,000 ea</span>
        </button>
        <button class="tool-btn" id="tool-measure" onclick="setTool('measure')">
          <span class="tool-icon">üìè</span>Measure<span class="tool-cost">ruler tool</span>
        </button>
      </div>
    </div>

    <div class="tool-section">
      <div class="tool-section-label">Brush Size</div>
      <input type="range" id="brush-size" min="8" max="60" value="20" style="width:100%;accent-color:var(--tan);">
    </div>

    <div class="panel-header" style="border-top:2px solid rgba(200,169,110,0.3);border-bottom:2px solid var(--tan);">‚õ≥ Holes</div>
    <div class="hole-list" id="hole-list">
      <div class="empty-hint" id="hole-empty">Place a flag on the canvas<br>to create a hole.</div>
    </div>
    <div style="padding:7px 11px;border-top:1px solid rgba(200,169,110,0.2);">
      <button class="btn primary" style="width:100%;font-size:11px;" onclick="addHoleManually()">+ Add Hole Manually</button>
    </div>
  </div>

  <!-- CANVAS -->
  <div class="canvas-area" id="canvas-area">
    <canvas id="main-canvas"></canvas>
    <div id="measure-tooltip"></div>
    <div class="canvas-zoom">
      <button onclick="zoom(1.2)">+</button>
      <button onclick="zoom(0.8)">‚àí</button>
      <button onclick="resetZoom()" style="font-size:10px;font-family:'Crimson Text',serif;">Fit</button>
    </div>
    <div class="canvas-instructions" id="canvas-hint">Select a tool and paint your course</div>
  </div>

  <!-- RIGHT PANEL -->
  <div class="panel right">
    <div class="panel-header">üìã Scorecard</div>
    <div class="scorecard-wrap">
      <div class="scorecard-title" id="sc-course-name">Your Course Name</div>
      <div id="scorecard-content"><div class="empty-hint">Add holes to see your scorecard.</div></div>
    </div>

    <div class="budget-panel">
      <div class="budget-panel-title">üí∞ Build Budget</div>
      <div class="budget-input-row">
        <label>Total $</label>
        <input type="number" id="budget-input" value="5000000" min="0" step="500000" onchange="updateBudgetUI()">
      </div>
      <div class="budget-bar-wrap">
        <div class="budget-bar-fill" id="budget-bar" style="width:0%;background:#27ae60;"></div>
      </div>
      <div id="budget-breakdown" class="budget-breakdown"></div>
    </div>
  </div>
</div>

<!-- Context Menu -->
<div id="context-menu">
  <button onclick="ctxEditHole()">‚úèÔ∏è Edit Hole</button>
  <button onclick="ctxDeleteElement()" class="sep" style="color:#e88">üóë Delete</button>
</div>

<!-- Edit Hole Modal -->
<div class="modal-backdrop" id="modal-hole">
  <div class="modal">
    <div class="modal-title" id="modal-hole-title">Hole Details</div>
    <div class="form-row">
      <label>Hole Name</label>
      <input type="text" id="modal-hole-name" placeholder="e.g. 'The Devil's Elbow'" maxlength="40">
    </div>
    <div class="form-row-inline">
      <div class="form-row">
        <label>Par</label>
        <select id="modal-hole-par"><option value="3">3</option><option value="4" selected>4</option><option value="5">5</option></select>
      </div>
      <div class="form-row">
        <label>Distance (yds)</label>
        <input type="number" id="modal-hole-dist" min="50" max="750" value="380">
      </div>
    </div>
    <div class="form-row">
      <label>Handicap (1‚Äì18)</label>
      <input type="number" id="modal-hole-hcp" min="1" max="18" value="1">
    </div>
    <div class="form-row">
      <label>Notes</label>
      <input type="text" id="modal-hole-notes" placeholder="Optional description‚Ä¶">
    </div>
    <div class="modal-actions">
      <button class="btn-modal" onclick="closeModal()">Cancel</button>
      <button class="btn-modal save" onclick="saveHoleDetails()">Save Hole</button>
    </div>
  </div>
</div>

<script>
// ============================================================
// SETUP
// ============================================================
const canvas = document.getElementById('main-canvas');
const ctx = canvas.getContext('2d');
const canvasArea = document.getElementById('canvas-area');
const measureTooltip = document.getElementById('measure-tooltip');

let currentTool = 'fairway';
let isDrawing = false;
let scale = 1, offsetX = 0, offsetY = 0;
let isDragging = false, dragStart = null;
let holes = [], tees = [];
let selectedHoleId = null, editingHoleId = null, ctxMenuTarget = null;
let undoStack = [];

// Measure state
let measureAnchor = null;    // fixed start point (world coords)
let measureLive = null;      // live end point (world coords)
let measureFixed = null;     // locked final end point after 2nd click

// Pixel-level budget tracking (sampled after each stroke)
let terrainAreas = { fairway:0, rough:0, green:0, bunker:0, water:0, trees:0, path:0 };

const COSTS = { fairway:800, rough:200, green:3500, bunker:1200, water:2000, trees:400, path:600 };
const TEE_COST = 5000, FLAG_COST = 8000;

const TERRAIN_DRAW_COLOR = {
  fairway:'#4a7c3f', rough:'#2e5c25', green:'#3aaf42',
  bunker:'#c8a96e', water:'#4a7fa5', trees:'#1e4a1e', path:'#b09070', erase:'#2a5a22'
};
const TERRAIN_DOT = {
  fairway:'#4a7c3f', rough:'#2e5c25', green:'#3aaf42',
  bunker:'#c8a96e', water:'#4a7fa5', trees:'#1e4a1e', path:'#b09070'
};

// Color classification for pixel sampling
// [r,g,b] of each terrain
const COLOR_REF = {
  fairway:[74,124,63], rough:[46,92,37], green:[58,175,66],
  bunker:[200,169,110], water:[74,127,165], trees:[30,74,30], path:[176,144,112]
};

// World canvas (large offscreen buffer)
const worldW = 2400, worldH = 1800;
const offCanvas = document.createElement('canvas');
offCanvas.width = worldW; offCanvas.height = worldH;
const offCtx = offCanvas.getContext('2d');

// Scale: 1 world pixel = 0.2 yards
const PX_TO_YARDS = 0.2;

// ============================================================
// INIT
// ============================================================
function init() {
  resizeCanvas();
  drawBg();
  render();
  updateBudgetUI();
  window.addEventListener('resize', () => { resizeCanvas(); render(); });
}

function resizeCanvas() {
  canvas.width = canvasArea.clientWidth;
  canvas.height = canvasArea.clientHeight;
  if (offsetX === 0 && offsetY === 0) {
    scale = Math.min(canvas.width/worldW, canvas.height/worldH) * 0.92;
    offsetX = (canvas.width - worldW*scale) / 2;
    offsetY = (canvas.height - worldH*scale) / 2;
  }
}

function drawBg() {
  offCtx.fillStyle = '#2a5a22';
  offCtx.fillRect(0, 0, worldW, worldH);
  offCtx.strokeStyle = 'rgba(255,255,255,0.03)';
  offCtx.lineWidth = 1;
  for (let x=0; x<worldW; x+=50){ offCtx.beginPath(); offCtx.moveTo(x,0); offCtx.lineTo(x,worldH); offCtx.stroke(); }
  for (let y=0; y<worldH; y+=50){ offCtx.beginPath(); offCtx.moveTo(0,y); offCtx.lineTo(worldW,y); offCtx.stroke(); }
}

// ============================================================
// RENDER
// ============================================================
function render() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.save();
  ctx.translate(offsetX, offsetY);
  ctx.scale(scale, scale);

  ctx.drawImage(offCanvas, 0, 0);

  // Border
  ctx.strokeStyle='#c8a96e'; ctx.lineWidth=3/scale;
  ctx.strokeRect(0,0,worldW,worldH);

  // Tees
  tees.forEach(t => {
    ctx.fillStyle='#e8d5a3';
    ctx.fillRect(t.x-9, t.y-9, 18, 18);
    ctx.strokeStyle='#6b4c2a'; ctx.lineWidth=2/scale;
    ctx.strokeRect(t.x-9, t.y-9, 18, 18);
    ctx.fillStyle='#3d2b15';
    ctx.font=`bold ${10/scale}px sans-serif`;
    ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.fillText('T', t.x, t.y);
  });

  // Flags
  holes.forEach(h => {
    ctx.beginPath(); ctx.arc(h.x, h.y, 10/scale, 0, Math.PI*2);
    ctx.fillStyle='#1a3a1a'; ctx.fill();
    ctx.strokeStyle='#c8a96e'; ctx.lineWidth=2/scale; ctx.stroke();
    ctx.beginPath(); ctx.moveTo(h.x, h.y-2/scale); ctx.lineTo(h.x, h.y-36/scale);
    ctx.strokeStyle='#ddd'; ctx.lineWidth=2/scale; ctx.stroke();
    ctx.beginPath(); ctx.moveTo(h.x,h.y-36/scale); ctx.lineTo(h.x+18/scale,h.y-28/scale); ctx.lineTo(h.x,h.y-20/scale);
    ctx.closePath(); ctx.fillStyle=h.id===selectedHoleId?'#ffdd44':'#b83232'; ctx.fill();
    ctx.fillStyle='#fff'; ctx.font=`bold ${10/scale}px sans-serif`;
    ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.fillText(h.number, h.x, h.y);
  });

  // Measure overlay
  const mEnd = measureLive || measureFixed;
  if (measureAnchor && mEnd) {
    ctx.beginPath();
    ctx.moveTo(measureAnchor.x, measureAnchor.y);
    ctx.lineTo(mEnd.x, mEnd.y);
    ctx.strokeStyle='rgba(255,224,80,0.9)';
    ctx.lineWidth=2/scale;
    ctx.setLineDash([10/scale, 5/scale]);
    ctx.stroke();
    ctx.setLineDash([]);

    // Tick marks every ~100 yards
    const dx=mEnd.x-measureAnchor.x, dy=mEnd.y-measureAnchor.y;
    const len=Math.hypot(dx,dy);
    const yardsPx = 1/PX_TO_YARDS; // pixels per yard
    const tickEvery = 100 * yardsPx; // every 100 yards
    if (len>0) {
      const nx=dx/len, ny=dy/len;
      const perp={x:-ny,y:nx};
      for(let d=tickEvery; d<len; d+=tickEvery) {
        const tx=measureAnchor.x+nx*d, ty=measureAnchor.y+ny*d;
        ctx.beginPath();
        ctx.moveTo(tx+perp.x*7/scale, ty+perp.y*7/scale);
        ctx.lineTo(tx-perp.x*7/scale, ty-perp.y*7/scale);
        ctx.strokeStyle='rgba(255,224,80,0.7)'; ctx.lineWidth=1.5/scale;
        ctx.stroke();
      }
    }

    // Dots
    [measureAnchor, mEnd].forEach(pt => {
      ctx.beginPath(); ctx.arc(pt.x,pt.y,5/scale,0,Math.PI*2);
      ctx.fillStyle='#ffe050'; ctx.fill();
    });

    // Distance label at midpoint (draw on main canvas, not world-transformed)
    const mid = { x:(measureAnchor.x+mEnd.x)/2, y:(measureAnchor.y+mEnd.y)/2 };
    const dist = Math.hypot(mEnd.x-measureAnchor.x, mEnd.y-measureAnchor.y) * PX_TO_YARDS;
    const label = `${Math.round(dist)} yds`;
    ctx.font=`${Math.max(11,14/scale)}px 'IM Fell English SC', serif`;
    ctx.textAlign='center'; ctx.textBaseline='bottom';
    ctx.fillStyle='rgba(20,16,6,0.75)';
    const tw=ctx.measureText(label).width;
    ctx.fillRect(mid.x-tw/2-4, mid.y-20/scale, tw+8, 16/scale);
    ctx.fillStyle='#ffe050';
    ctx.fillText(label, mid.x, mid.y-4/scale);
  }

  if (measureAnchor && !mEnd) {
    ctx.beginPath(); ctx.arc(measureAnchor.x,measureAnchor.y,5/scale,0,Math.PI*2);
    ctx.fillStyle='#ffe050'; ctx.fill();
  }

  ctx.restore();
}

// ============================================================
// TOOLS
// ============================================================
function setTool(t) {
  currentTool = t;
  document.querySelectorAll('.tool-btn').forEach(b=>b.classList.remove('active'));
  const el=document.getElementById('tool-'+t); if(el) el.classList.add('active');

  if (t !== 'measure') {
    measureAnchor = null; measureLive = null; measureFixed = null;
    measureTooltip.style.display = 'none';
    render();
  }

  const HINTS = {
    fairway:'Paint fairway ‚Äî click & drag',
    rough:'Paint rough ‚Äî click & drag',
    green:'Paint putting green ‚Äî click & drag',
    bunker:'Paint sand bunker ‚Äî click & drag',
    water:'Paint water hazard ‚Äî click & drag',
    trees:'Paint tree line ‚Äî click & drag',
    path:'Paint cart path ‚Äî click & drag',
    erase:'Erase terrain ‚Äî click & drag',
    tee:'Click to place a Tee Box ($5,000)',
    flag:'Click to place a Hole Flag ($8,000)',
    measure:'1st click = start point ¬∑ 2nd click = measure ¬∑ 3rd click = reset',
  };
  document.getElementById('canvas-hint').textContent = HINTS[t]||'';
}

// ============================================================
// COORDINATE HELPERS
// ============================================================
function getWorldPos(e) {
  const r=canvas.getBoundingClientRect();
  return { x:(e.clientX-r.left-offsetX)/scale, y:(e.clientY-r.top-offsetY)/scale };
}

// ============================================================
// EVENTS
// ============================================================
canvas.addEventListener('mousedown', e => {
  if (e.button===1) { isDragging=true; dragStart={x:e.clientX-offsetX,y:e.clientY-offsetY}; e.preventDefault(); return; }
  if (e.button===2) return;
  const pos=getWorldPos(e);
  if (currentTool==='flag')    { placeFlag(pos); return; }
  if (currentTool==='tee')     { placeTee(pos); return; }
  if (currentTool==='measure') { handleMeasureDown(pos); return; }
  saveUndo();
  isDrawing=true;
  paintAt(pos);
});

canvas.addEventListener('mousemove', e => {
  const pos=getWorldPos(e);
  if (isDragging) { offsetX=e.clientX-dragStart.x; offsetY=e.clientY-dragStart.y; render(); return; }
  if (currentTool==='measure' && measureAnchor && !measureFixed) {
    measureLive=pos; render(); return;
  }
  if (!isDrawing) return;
  paintAt(pos);
  render();
});

canvas.addEventListener('mouseup', () => {
  if (isDrawing) { isDrawing=false; render(); recalcFromPixels(); }
  isDragging=false;
});
canvas.addEventListener('mouseleave', () => { isDrawing=false; isDragging=false; if(currentTool!=='measure'){measureTooltip.style.display='none';} });

canvas.addEventListener('wheel', e => {
  e.preventDefault();
  const r=canvas.getBoundingClientRect();
  const mx=e.clientX-r.left, my=e.clientY-r.top;
  const delta=e.deltaY<0?1.1:0.9;
  const ns=Math.min(5,Math.max(0.15,scale*delta));
  offsetX=mx-(mx-offsetX)*(ns/scale); offsetY=my-(my-offsetY)*(ns/scale);
  scale=ns; render();
},{passive:false});

canvas.addEventListener('contextmenu', e => {
  e.preventDefault();
  const pos=getWorldPos(e);
  const found=holes.find(h=>Math.hypot(h.x-pos.x,h.y-pos.y)<20);
  if(found){ctxMenuTarget=found;const m=document.getElementById('context-menu');m.style.display='flex';m.style.left=e.clientX+'px';m.style.top=e.clientY+'px';}
});
document.addEventListener('click',()=>document.getElementById('context-menu').style.display='none');

// ============================================================
// MEASURE TOOL
// ============================================================
function handleMeasureDown(pos) {
  if (!measureAnchor) {
    // First click: set anchor
    measureAnchor = pos;
    measureFixed = null;
    measureLive = null;
    render();
  } else if (!measureFixed) {
    // Second click: lock measurement
    measureFixed = pos;
    measureLive = null;
    render();
  } else {
    // Third click: reset
    measureAnchor = null;
    measureFixed = null;
    measureLive = null;
    render();
  }
}

// ============================================================
// PAINTING
// ============================================================
function paintAt(pos) {
  const brush = parseInt(document.getElementById('brush-size').value);
  if (currentTool==='erase') {
    offCtx.fillStyle='#2a5a22';
    offCtx.beginPath(); offCtx.arc(pos.x,pos.y,brush,0,Math.PI*2); offCtx.fill();
  } else if (currentTool==='trees') {
    for(let i=0;i<6;i++){
      const rx=pos.x+(Math.random()-.5)*brush*2, ry=pos.y+(Math.random()-.5)*brush*2;
      offCtx.beginPath(); offCtx.arc(rx,ry,brush*.4,0,Math.PI*2);
      offCtx.fillStyle=i%2===0?'#1e4a1e':'#2a6a2a'; offCtx.fill();
    }
  } else {
    offCtx.beginPath(); offCtx.arc(pos.x,pos.y,brush,0,Math.PI*2);
    offCtx.fillStyle=TERRAIN_DRAW_COLOR[currentTool]||'#4a7c3f'; offCtx.fill();
  }
}

// ============================================================
// BUDGET: sample pixels after each stroke
// ============================================================
function recalcFromPixels() {
  // Sub-sample for performance: every Nth pixel
  const STEP = 6; // sample every 6px in each axis
  const data = offCtx.getImageData(0,0,worldW,worldH).data;
  const counts = {fairway:0,rough:0,green:0,bunker:0,water:0,trees:0,path:0};
  for(let py=0;py<worldH;py+=STEP){
    for(let px=0;px<worldW;px+=STEP){
      const i=(py*worldW+px)*4;
      const r=data[i],g=data[i+1],b=data[i+2];
      const k=classifyPx(r,g,b);
      if(k) counts[k]++;
    }
  }
  // Each counted sample = STEP*STEP real pixels
  // Convert to "cost units" (per 100 sq pixels)
  for(let k in counts) {
    terrainAreas[k] = counts[k]*STEP*STEP/100;
  }
  updateBudgetUI();
}

function classifyPx(r,g,b) {
  // Skip base background (dark green ~42,90,34)
  if(r<55&&g>60&&g<115&&b<55&&Math.abs(r-42)<20&&Math.abs(g-90)<25&&Math.abs(b-34)<20) return null;
  let best=null,bestD=40*40*3;
  for(let k in COLOR_REF){
    const c=COLOR_REF[k];
    const d=(r-c[0])**2+(g-c[1])**2+(b-c[2])**2;
    if(d<bestD){bestD=d;best=k;}
  }
  return bestD<3200?best:null;
}

// ============================================================
// BUDGET UI
// ============================================================
function updateBudgetUI() {
  const budget=parseInt(document.getElementById('budget-input').value)||5000000;
  let terrTotal=0;
  for(let k in terrainAreas) terrTotal+=terrainAreas[k]*(COSTS[k]||0);
  const teeCost=tees.length*TEE_COST, flagCost=holes.length*FLAG_COST;
  const total=Math.round(terrTotal+teeCost+flagCost);
  const remaining=budget-total;
  const pct=Math.min(100,budget>0?total/budget*100:0);
  const barCol=pct<70?'#27ae60':pct<90?'#e8a060':'#c0392b';

  // Header badge
  document.getElementById('hb-bar').style.cssText=`width:${pct}%;background:${barCol};`;
  document.getElementById('hb-spent').textContent='$'+total.toLocaleString();
  document.getElementById('hb-total').textContent='/ $'+budget.toLocaleString();
  // Right panel bar
  document.getElementById('budget-bar').style.cssText=`width:${pct}%;background:${barCol};`;

  // Breakdown lines
  let lines='';
  const NAMES={fairway:'Fairway',rough:'Rough',green:'Greens',bunker:'Bunkers',water:'Water',trees:'Trees',path:'Cart Path'};
  for(let k in terrainAreas){
    const cost=Math.round(terrainAreas[k]*(COSTS[k]||0));
    if(cost<10) continue;
    lines+=`<div class="budget-line">
      <span class="bl-name"><span class="bl-dot" style="background:${TERRAIN_DOT[k]||'#888'}"></span>${NAMES[k]||k}</span>
      <span class="bl-cost">$${cost.toLocaleString()}</span></div>`;
  }
  if(tees.length>0) lines+=`<div class="budget-line"><span class="bl-name">üèå Tee Boxes √ó${tees.length}</span><span class="bl-cost">$${teeCost.toLocaleString()}</span></div>`;
  if(holes.length>0) lines+=`<div class="budget-line"><span class="bl-name">‚õ≥ Holes √ó${holes.length}</span><span class="bl-cost">$${flagCost.toLocaleString()}</span></div>`;

  const remCls=remaining<0?'clr-over':pct>=90?'clr-warn':'clr-ok';
  const remText=remaining<0?`OVER $${Math.abs(remaining).toLocaleString()}`:`$${remaining.toLocaleString()} remaining`;

  document.getElementById('budget-breakdown').innerHTML=lines+`
    <div class="budget-total-row"><span>Total Spent</span><span style="font-size:13px">$${total.toLocaleString()}</span></div>
    <div class="budget-total-row" style="margin-top:2px"><span>Budget Left</span><span class="${remCls}" style="font-size:13px">${remText}</span></div>`;
}

// ============================================================
// OBJECTS
// ============================================================
function placeFlag(pos) {
  saveUndo();
  const n=holes.length+1;
  const h={id:Date.now(),x:pos.x,y:pos.y,number:n,name:`Hole ${n}`,par:4,dist:380,hcp:n,notes:''};
  holes.push(h); render(); updateHoleList(); updateScorecard(); updateBudgetUI();
  openHoleModal(h.id);
}
function placeTee(pos) {
  saveUndo(); tees.push({x:pos.x,y:pos.y}); render(); updateBudgetUI();
}
function addHoleManually() {
  const n=holes.length+1;
  const h={id:Date.now(),x:worldW/2+(Math.random()-.5)*400,y:worldH/2+(Math.random()-.5)*400,number:n,name:`Hole ${n}`,par:4,dist:380,hcp:n,notes:''};
  holes.push(h); render(); updateHoleList(); updateScorecard(); updateBudgetUI(); openHoleModal(h.id);
}

// ============================================================
// UNDO
// ============================================================
function saveUndo(){
  if(undoStack.length>20) undoStack.shift();
  undoStack.push(offCtx.getImageData(0,0,worldW,worldH));
}
document.addEventListener('keydown',e=>{
  if((e.ctrlKey||e.metaKey)&&e.key==='z'&&undoStack.length>0){
    offCtx.putImageData(undoStack.pop(),0,0); render(); recalcFromPixels();
  }
});

// ============================================================
// HOLE LIST
// ============================================================
function updateHoleList() {
  const list=document.getElementById('hole-list');
  if(holes.length===0){list.innerHTML='';list.appendChild(document.getElementById('hole-empty'));return;}
  list.innerHTML='';
  holes.forEach(h=>{
    const div=document.createElement('div');
    div.className='hole-item'+(h.id===selectedHoleId?' selected':'');
    div.onclick=()=>{selectedHoleId=h.id;render();updateHoleList();};
    div.innerHTML=`<button class="hole-delete" onclick="event.stopPropagation();deleteHole(${h.id})">‚úï</button>
      <div class="hole-item-header"><span class="hole-number">Hole ${h.number}</span><span class="hole-par par${h.par}">Par ${h.par}</span></div>
      <input class="hole-name-input" value="${h.name}" placeholder="Name‚Ä¶"
        onchange="updateHoleField(${h.id},'name',this.value)" onclick="event.stopPropagation()">
      <div class="hole-details-row">
        <div><div class="detail-label">Par</div>
          <select class="inline-select" onchange="updateHoleField(${h.id},'par',parseInt(this.value))" onclick="event.stopPropagation()">
            <option value="3" ${h.par==3?'selected':''}>3</option>
            <option value="4" ${h.par==4?'selected':''}>4</option>
            <option value="5" ${h.par==5?'selected':''}>5</option>
          </select></div>
        <div><div class="detail-label">Yards</div>
          <input class="hole-detail-input" type="number" value="${h.dist}" min="50" max="750"
            onchange="updateHoleField(${h.id},'dist',parseInt(this.value))" onclick="event.stopPropagation()"></div>
        <div><div class="detail-label">Hcp</div>
          <input class="hole-detail-input" type="number" value="${h.hcp}" min="1" max="18"
            onchange="updateHoleField(${h.id},'hcp',parseInt(this.value))" onclick="event.stopPropagation()"></div>
      </div>`;
    list.appendChild(div);
  });
}
function updateHoleField(id,field,val){const h=holes.find(x=>x.id===id);if(h){h[field]=val;updateScorecard();updateHoleList();render();}}
function deleteHole(id){
  holes=holes.filter(h=>h.id!==id);holes.forEach((h,i)=>h.number=i+1);
  if(selectedHoleId===id)selectedHoleId=null;
  render();updateHoleList();updateScorecard();updateBudgetUI();
}

// ============================================================
// SCORECARD
// ============================================================
function updateScorecard(){
  const name=document.getElementById('course-name').value||'Your Course';
  document.getElementById('sc-course-name').textContent=name;
  const cont=document.getElementById('scorecard-content');
  if(!holes.length){cont.innerHTML='<div class="empty-hint">Add holes to see scorecard.</div>';return;}
  let html=buildTable('Front Nine',holes.slice(0,9));
  if(holes.length>9)html+=buildTable('Back Nine',holes.slice(9,18));
  const tp=holes.reduce((s,h)=>s+h.par,0),td=holes.reduce((s,h)=>s+h.dist,0);
  html+=`<div class="stat-box"><span class="stat-label">Total Par</span><span class="stat-value">${tp}</span></div>
         <div class="stat-box"><span class="stat-label">Total Yards</span><span class="stat-value">${td.toLocaleString()}</span></div>
         <div class="stat-box"><span class="stat-label">Holes</span><span class="stat-value">${holes.length}</span></div>`;
  cont.innerHTML=html;
}
function buildTable(label,set){
  if(!set.length)return'';
  const sp=set.reduce((s,h)=>s+h.par,0),sd=set.reduce((s,h)=>s+h.dist,0);
  const rows=set.map(h=>`<tr><td>${h.number}</td><td style="text-align:left;font-style:italic;max-width:60px;overflow:hidden;white-space:nowrap;font-size:9px">${h.name}</td><td class="par${h.par}">${h.par}</td><td>${h.dist}</td><td>${h.hcp}</td></tr>`).join('');
  return`<div class="scorecard-title" style="margin-top:7px">${label}</div>
    <table class="scorecard"><thead><tr><th>#</th><th>Name</th><th>Par</th><th>Yds</th><th>Hcp</th></tr></thead>
    <tbody>${rows}<tr><td colspan="2" class="sc-total" style="text-align:left">Total</td><td class="sc-total">${sp}</td><td class="sc-total">${sd}</td><td></td></tr></tbody></table>`;
}
document.getElementById('course-name').addEventListener('input',updateScorecard);

// ============================================================
// MODAL
// ============================================================
function openHoleModal(id){
  const h=holes.find(x=>x.id===id);if(!h)return;
  editingHoleId=id;
  document.getElementById('modal-hole-title').textContent=`Hole ${h.number} Details`;
  document.getElementById('modal-hole-name').value=h.name;
  document.getElementById('modal-hole-par').value=h.par;
  document.getElementById('modal-hole-dist').value=h.dist;
  document.getElementById('modal-hole-hcp').value=h.hcp;
  document.getElementById('modal-hole-notes').value=h.notes||'';
  document.getElementById('modal-hole').classList.add('open');
}
function closeModal(){document.getElementById('modal-hole').classList.remove('open');editingHoleId=null;}
function saveHoleDetails(){
  if(!editingHoleId)return;
  const h=holes.find(x=>x.id===editingHoleId);if(!h)return;
  h.name=document.getElementById('modal-hole-name').value||h.name;
  h.par=parseInt(document.getElementById('modal-hole-par').value);
  h.dist=parseInt(document.getElementById('modal-hole-dist').value)||h.dist;
  h.hcp=parseInt(document.getElementById('modal-hole-hcp').value)||h.hcp;
  h.notes=document.getElementById('modal-hole-notes').value;
  closeModal();updateHoleList();updateScorecard();render();
}

// ============================================================
// CONTEXT MENU
// ============================================================
function ctxEditHole(){if(ctxMenuTarget)openHoleModal(ctxMenuTarget.id);}
function ctxDeleteElement(){if(ctxMenuTarget)deleteHole(ctxMenuTarget.id);}

// ============================================================
// ZOOM / PAN
// ============================================================
function zoom(f){
  const cx=canvas.width/2,cy=canvas.height/2;
  const ns=Math.min(5,Math.max(0.15,scale*f));
  offsetX=cx-(cx-offsetX)*(ns/scale);offsetY=cy-(cy-offsetY)*(ns/scale);scale=ns;render();
}
function resetZoom(){
  scale=Math.min(canvas.width/worldW,canvas.height/worldH)*.92;
  offsetX=(canvas.width-worldW*scale)/2;offsetY=(canvas.height-worldH*scale)/2;render();
}

// ============================================================
// SAVE / LOAD / CLEAR
// ============================================================
function saveCourse(){
  localStorage.setItem('gk_course',JSON.stringify({name:document.getElementById('course-name').value,holes,tees,terrainAreas,budget:document.getElementById('budget-input').value}));
  localStorage.setItem('gk_img',offCanvas.toDataURL('image/png'));
  alert('‚úÖ Course saved!');
}
function loadCourse(){
  const raw=localStorage.getItem('gk_course'),img=localStorage.getItem('gk_img');
  if(!raw){alert('No saved course found.');return;}
  const d=JSON.parse(raw);
  document.getElementById('course-name').value=d.name||'';
  holes=d.holes||[];tees=d.tees||[];
  if(d.terrainAreas)terrainAreas={...terrainAreas,...d.terrainAreas};
  if(d.budget)document.getElementById('budget-input').value=d.budget;
  if(img){const im=new Image();im.onload=()=>{offCtx.drawImage(im,0,0);render();};im.src=img;}
  updateHoleList();updateScorecard();updateBudgetUI();render();alert('‚úÖ Course loaded!');
}
function clearCanvas(){
  if(!confirm('Clear the entire course?'))return;
  saveUndo();
  offCtx.fillStyle='#2a5a22';offCtx.fillRect(0,0,worldW,worldH);drawBg();
  holes=[];tees=[];terrainAreas={fairway:0,rough:0,green:0,bunker:0,water:0,trees:0,path:0};
  measureAnchor=null;measureFixed=null;measureLive=null;
  render();updateHoleList();updateScorecard();updateBudgetUI();
}

init();
</script>
</body>
</html>
